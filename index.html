<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>W2H Tool v1.8 ‚Äì Live Place ID Fetch (via Proxy, ohne Token)</title>
  <style>
    body {
      font-family: sans-serif;
      background-color: #d6f3ee;
      padding: 20px;
    }
    input, button, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      font-family: monospace;
    }
    textarea {
      height: 200px;
    }
    .ok { color: green; }
    .error { color: red; }
  </style>
</head>
<body>

<h2>üåç W2H Tool v1.8 ‚Äì Live Place ID Fetch (via Proxy, ohne Token)</h2>

<label>üî§ Eingabe (z.‚ÄØB. Plus Code oder Ortsname):</label>
<input id="inputText" placeholder="z.‚ÄØB. 9C3W+X7 Wien oder Hotel Lipa Piran" />

<label>üì¶ GitHub Repo (z.‚ÄØB. Sailbuddy/w2h-places-import):</label>
<input id="repo" value="Sailbuddy/w2h-places-import" />

<button onclick="los()">‚û°Ô∏è Place ID abrufen & speichern</button>

<h3>üìÑ Log</h3>
<textarea id="log" readonly></textarea>

<script>
  async function los() {
    const input = document.getElementById("inputText").value.trim();
    const repo = document.getElementById("repo").value.trim();
    const log = document.getElementById("log");
    log.value += `üîç Suche Ort: ${input}\n`;

    try {
      const response = await fetch(`https://w2h-proxy.netlify.app/.netlify/functions/places?input=${encodeURIComponent(input)}`);
      const data = await response.json();

      if (!data.result || !data.result.candidates || data.result.candidates.length === 0) {
        log.value += "‚ùå Kein Ort gefunden. Pr√ºfe Eingabe.\n";
        return;
      }

      const candidate = data.result.candidates[0];
      const placeId = candidate.place_id;
      const name = candidate.name || input;

      log.value += `‚úÖ Gefunden: ${input} ‚Üí ${placeId}\n`;

      const eintrag = {
        plus_code_input: input,
        place_id: placeId,
        name: name,
        status: "pending"
      };

      await uploadJson(repo, "data/place_ids.json", [placeId], false);
      await uploadJson(repo, "data/place_ids_archive.json", [placeId], true);

    } catch (err) {
      log.value += `üî• Fehler bei der Abfrage:\n${err.message}\n`;
    }
  }

  async function uploadJson(repo, path, data, append) {
    const url = `https://w2h-proxy.netlify.app/.netlify/functions/github-token`;
    const log = document.getElementById("log");

    try {
      const tokenRes = await fetch(url);
      const tokenData = await tokenRes.json();

      if (!tokenData.token) {
        log.value += "‚ùå Kein Token vom Server erhalten.\n";
        return;
      }

      const token = tokenData.token;

      const githubUrl = `https://api.github.com/repos/${repo}/contents/${path}`;
      let sha = null;
      let bestehend = [];

      const check = await fetch(githubUrl, {
        headers: { Authorization: `token ${token}` }
      });

      if (check.ok) {
        const json = await check.json();
        sha = json.sha;
        bestehend = JSON.parse(atob(json.content));
      }

      const neueDaten = append ? [...new Set([...bestehend, ...data])] : data;
      const b64 = btoa(JSON.stringify(neueDaten, null, 2));

      const res = await fetch(githubUrl, {
        method: "PUT",
        headers: {
          Authorization: `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `üåç W2H Live Fetch Upload ${new Date().toISOString()}`,
          content: b64,
          sha: sha || undefined
        })
      });

      if (res.ok) {
        log.value += `‚úÖ Hochgeladen nach ${path}\n`;
      } else {
        const err = await res.text();
        log.value += `‚ùå Fehler bei Upload nach ${path}:\n${err}\n`;
      }
    } catch (err) {
      log.value += `‚ùå Fehler beim Token- oder Uploadvorgang:\n${err.message}\n`;
    }
  }
</script>
</body>
</html>
